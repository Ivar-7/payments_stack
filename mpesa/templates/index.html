<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>M-Pesa Integration</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
  </head>
  <body>
    <div class="container">
      <!-- Home Section -->
      <div class="row justify-content-center">
        <div class="col-8 text-center">
          <h1 class="mt-5">M-Pesa Integration</h1>
          <p class="lead">Welcome to our M-Pesa payment system.</p>
          <button onclick="showPaymentForm()" class="btn btn-primary mt-3">
            Make a Payment
          </button>
        </div>
      </div>

      <!-- Payment Form Section -->
      <div
        id="paymentSection"
        class="row justify-content-center mt-5"
        style="display: none"
      >
        <div class="col-6">
          <h2 class="text-center">M-Pesa Payment Form</h2>
          <form method="post" action="/mpesa/mpesa_payment/" class="mt-4">
            {% csrf_token %}
            <div class="form-group">
              <label for="phone">Phone Number:</label>
              <input
                type="text"
                id="phone"
                name="phone"
                class="form-control"
                placeholder="254XXXXXXXXX"
                required
              />
            </div>
            <div class="form-group">
              <label for="amount">Amount (KSH):</label>
              <input
                type="number"
                id="amount"
                name="amount"
                class="form-control"
                min="1"
                required
              />
            </div>
            <button type="submit" class="btn btn-success">Make Payment</button>
            <button
              type="button"
              onclick="hidePaymentForm()"
              class="btn btn-secondary ml-2"
            >
              Cancel
            </button>
          </form>
        </div>
      </div>

      {% if response %}
      <div class="row justify-content-center mt-4">
        <div class="col-10">
          <!-- Debug: Show raw response for troubleshooting -->
          <!-- <div class="alert alert-warning mb-3">
            <h6>Debug Info (Raw Response):</h6>
            <pre>{{ response }}</pre>
          </div> -->
          
          {% if response.ResponseCode == '0' %}
          <div class="alert alert-success">
            <h4>Transaction Initiated Successfully!</h4>
            <p><strong>{{ response.CustomerMessage }}</strong></p>
            <div class="mt-3">
              <p>
                <strong>Merchant Request ID:</strong> {{ response.MerchantRequestID }}
              </p>
              <p>
                <strong>Checkout Request ID:</strong> {{ response.CheckoutRequestID }}
              </p>
              <p>
                <strong>Response Description:</strong> {{ response.ResponseDescription }}
              </p>
            </div>
            <div class="alert alert-info mt-3">
              <i class="fas fa-mobile-alt"></i> Please complete the transaction
              on your phone by entering your M-Pesa PIN.
            </div>
          </div>
          {% else %}
          <div class="alert alert-danger">
            <h4>Transaction Failed</h4>
            <p>
              <strong>Error Code:</strong> {{ response.ResponseCode|default:"Unknown" }}
            </p>
            <p>
              <strong>Error Message:</strong> {{ response.ResponseDescription|default:response.errorMessage|default:"Transaction could not be processed" }}
            </p>
            {% if response.CustomerMessage %}
            <p>
              <strong>Customer Message:</strong> {{ response.CustomerMessage }}
            </p>
            {% endif %}
          </div>
          {% endif %}

          <!-- Debug Information (remove in production) -->
          <div class="mt-4">
            <button class="btn btn-info btn-sm" onclick="toggleDebugInfo()">
              Show/Hide Debug Info
            </button>
            <div id="debugInfo" style="display: none" class="mt-3">
              <div class="card">
                <div class="card-header">
                  <h6>Full Response (Debug)</h6>
                </div>
                <div class="card-body">
                  <pre class="bg-light p-2"><code>{{ response.debug_json|default:response }}</code></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <script>
      function showPaymentForm() {
          const paymentSection = document.getElementById('paymentSection');
          if (paymentSection) {
              paymentSection.style.display = 'block';
              paymentSection.scrollIntoView({ behavior: 'smooth' });
          }
      }

      function hidePaymentForm() {
          const paymentSection = document.getElementById('paymentSection');
          if (paymentSection) {
              paymentSection.style.display = 'none';
              window.scrollTo({ top: 0, behavior: 'smooth' });
          }
      }

      function toggleDebugInfo() {
          const debugInfo = document.getElementById('debugInfo');
          if (debugInfo) {
              if (debugInfo.style.display === 'none' || debugInfo.style.display === '') {
                  debugInfo.style.display = 'block';
              } else {
                  debugInfo.style.display = 'none';
              }
          } else {
              console.log('Debug info element not found');
          }
      }

      // Auto-show payment form if there's a response (after form submission)
      document.addEventListener('DOMContentLoaded', function() {
          console.log('Page loaded');
          // Check if there's a response section visible
          const responseSection = document.querySelector('.alert');
          if (responseSection) {
              console.log('Response section found, showing payment form');
              showPaymentForm();
          } else {
              console.log('No response section found');
          }
      });
    </script>
  </body>
</html>
